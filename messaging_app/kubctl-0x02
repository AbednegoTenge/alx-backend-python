#!/bin/bash

echo "----kubctl-0x02: Blue-Green Deployment Script----"

# Deploy Blue version
echo "üîµ Deploying Blue version (v1.0)..."
kubectl apply -f blue_deployment.yaml

# Wait for blue deployment to be ready
echo "‚è≥ Waiting for Blue deployment to be ready..."
kubectl wait --for=condition=available deployment/django-messaging-app-blue --timeout=120s

# Check blue deployment status
echo ""
echo "üìä Blue Deployment Status:"
kubectl get deployment django-messaging-app-blue
kubectl get pods -l version=blue

# Check logs for blue deployment
echo ""
echo "üìù Checking Blue deployment logs for errors..."
BLUE_POD=$(kubectl get pods -l version=blue -o jsonpath='{.items[0].metadata.name}')
if [ -n "$BLUE_POD" ]; then
    echo "Logs from Blue pod: $BLUE_POD"
    kubectl logs $BLUE_POD --tail=20
    
    # Check for errors
    ERROR_COUNT=$(kubectl logs $BLUE_POD | grep -i "error\|exception\|failed" | wc -l)
    if [ $ERROR_COUNT -gt 0 ]; then
        echo "‚ö†Ô∏è  Found $ERROR_COUNT error messages in Blue deployment logs"
    else
        echo "‚úÖ No errors found in Blue deployment logs"
    fi
else
    echo "‚ùå No Blue pods found"
fi

# Apply service pointing to blue version
echo ""
echo "üîß Applying service to route traffic to Blue version..."
kubectl apply -f kubeservice.yaml

# Deploy Green version
echo ""
echo "üü¢ Deploying Green version (v2.0)..."
kubectl apply -f green_deployment.yaml

# Wait for green deployment to be ready
echo "‚è≥ Waiting for Green deployment to be ready..."
kubectl wait --for=condition=available deployment/django-messaging-app-green --timeout=120s

# Check green deployment status
echo ""
echo "üìä Green Deployment Status:"
kubectl get deployment django-messaging-app-green
kubectl get pods -l version=green

# Check logs for green deployment
echo ""
echo "üìù Checking Green deployment logs for errors..."
GREEN_POD=$(kubectl get pods -l version=green -o jsonpath='{.items[0].metadata.name}')
if [ -n "$GREEN_POD" ]; then
    echo "Logs from Green pod: $GREEN_POD"
    kubectl logs $GREEN_POD --tail=20
    
    # Check for errors
    ERROR_COUNT=$(kubectl logs $GREEN_POD | grep -i "error\|exception\|failed" | wc -l)
    if [ $ERROR_COUNT -gt 0 ]; then
        echo "‚ö†Ô∏è  Found $ERROR_COUNT error messages in Green deployment logs"
    else
        echo "‚úÖ No errors found in Green deployment logs"
    fi
else
    echo "‚ùå No Green pods found"
fi

# Show both deployments
echo ""
echo "üì¶ All Deployments:"
kubectl get deployments -l app=django-messaging
kubectl get pods -l app=django-messaging

echo ""
echo "‚ÑπÔ∏è  Traffic is currently routed to: BLUE version"
echo "‚ÑπÔ∏è  To switch traffic to GREEN version, update kubeservice.yaml:"
echo "   Change 'version: blue' to 'version: green' in the service selector"
echo "   Then run: kubectl apply -f kubeservice.yaml"

echo ""
echo "‚úÖ Blue-Green deployment complete!"
